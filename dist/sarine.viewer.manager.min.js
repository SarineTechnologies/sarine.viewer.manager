/*!
sarine.viewer.manager - v0.18.0 -  Thursday, February 16th, 2017, 2:25:08 AM 
 The source code, name, and look and feel of the software are Copyright Â© 2015 Sarine Technologies Ltd. All Rights Reserved. You may not duplicate, copy, reuse, sell or otherwise exploit any portion of the code, content or visual design elements without express written permission from Sarine Technologies Ltd. The terms and conditions of the sarine.com website (http://sarine.com/terms-and-conditions/) apply to the access and use of this software.
 */
(function(){var ViewerManger;ViewerManger=function(){function ViewerManger(a){fromTag=a.fromTag,toTag=a.toTag,stoneViews=a.stoneViews,template=a.template,jsons=a.jsons,logicRoot=a.logicRoot,templateContainers=a.templateContainers,window.cacheVersion="?__VERSION__",configuration.cacheVersion&&(window.cacheVersion+=configuration.cacheVersion),initLocalStorage("stones"),initLocalStorage("templates"),initTemplatesMapper(),initTemplates(),logicRoot=stoneViews.viewersBaseUrl+"atomic/{version}/js/",jsons=stoneViews.viewersBaseUrl+"atomic/{version}/jsons/",jsonsAll=stoneViews.viewersBaseUrl+"atomic/bundle/all.json",allViewresList=stoneViews.viewers,viewers=[],this.bind=a.template?loadTemplate:bindElementToSelector}var addViewer,allViewresList,bindElementToSelector,configurationToTemplateMapper,existInConfig,experiencesList,findAttribute,fromTag,getAllTemplates,getPath,getTemplateLists,getTemplateMapperByConfigName,iconsList,infoPopupsList,initLocalStorage,initTemplates,initTemplatesMapper,jsons,jsonsAll,jsonsAllObj,loadTemplate,logicPath,logicRoot,popupInfoMapper,recurse,stoneViews,template,templateContainers,toTag,viewers;return viewers=[],stoneViews=void 0,fromTag=void 0,toTag=void 0,stoneViews=void 0,template=void 0,jsons=void 0,jsonsAll=void 0,jsonsAllObj=void 0,logicRoot=void 0,logicPath=void 0,allViewresList=void 0,configurationToTemplateMapper=void 0,popupInfoMapper=void 0,experiencesList=void 0,iconsList=void 0,infoPopupsList=void 0,templateContainers=void 0,ViewerManger.prototype.bind=Error,getTemplateLists=function(){return{experiencesList:experiencesList,iconsList:iconsList,infoPopupsList:infoPopupsList}},getPath=function(a){var b;return b=a.split("/"),b.pop(),b.join("/")},initLocalStorage=function(a){if("undefined"!=typeof Storage&&null===localStorage.getItem(a))return localStorage.setItem(a,"[]")},initTemplates=function(){var a;a=getAllTemplates(),a&&(experiencesList=a.templates,iconsList=a.icons,infoPopupsList=a.infoPopups)},initTemplatesMapper=function(){configurationToTemplateMapper=null,window.sarineViewerTemplatesMapping&&sarineViewerTemplatesMapping.mapper&&(configurationToTemplateMapper=sarineViewerTemplatesMapping.mapper.getMapper())},bindElementToSelector=function(a){var b,c,d;return c=$.Deferred(),b=[],d=this,document.viewersList=JSON.parse(JSON.stringify(allViewresList)),$(a).find(fromTag).each(function(a){return function(a,c){var d,e,f,g,h,i,j,k,l,m;for(i=$("<"+toTag+">"),j=$(c).attr("viewer"),h=$(c).attr("order")||99,m=c.attributes,k=0,l=m.length;k<l;k++)e=m[k],i.data(e.name,e.value);return i.data({type:$(c).attr("viewer"),order:h,version:$(c).attr("version")}),i.attr({id:"viewr_"+a,order:h}),"loupe3DFullInspection"===j&&(g=$(c).attr("menu")||!0,f=$(c).attr("coordinates")||!0,d=$(c).attr("active")||!0,i.data({menu:g,coordinates:f,active:d}),i.attr({menu:g,coordinates:f,active:d})),i.addClass("viewer "+j),$(c).replaceWith(i),b.push(addViewer(j,i))}}(this)),$(a).find("*[data-sarine-info]").each(function(a){return function(a,b){var c;return c=$(b),c.text(findAttribute(stoneViews,c.data("sarineInfo")))}}(this)),$(a).find("*[data-sarine-info-display]").each(function(a){return function(a,b){var c,d,e,f;if(c=$(b),e=findAttribute(stoneViews,c.data("sarineInfoDisplay")),f=findAttribute(gradeScales,c.data("sarineInfoDisplay").replace("stoneProperties.","")),f&&e&&(d=f.filter(function(a){return a.name===e})[0],null!==d&&"undefined"!=typeof d))return c.text(d["default-display"])}}(this)),$(a).find("*[data-sarine-report]").each(function(a){return function(a,b){var c,d,e,f;return c=$(b),d=c.data("sarineReport"),d.indexOf("::")===-1?c.text(findAttribute(report,d)):(e=findAttribute(report,d.split("::")[0]),f=d.split("::")[1],c.text(moment.utc(e).format(f)))}}(this)),$.when.apply($,b).then(function(){return c.resolve()}),c},recurse=function(a,b){if(0===b.length)return a;if(a)return recurse(a[b.shift()],b)},findAttribute=function(a,b){return recurse(a,b.split("."))},getTemplateMapperByConfigName=function(a){var b,c;return b={},configurationToTemplateMapper[a.atom].infos?b.infos=configurationToTemplateMapper[a.atom].infos:b.infos=[],"lightReportViewer"===a.atom?a.hasOwnProperty("templateVersion")?(b.iconName=configurationToTemplateMapper[a.atom].icon.templateVersion,c=parseInt(a.templateVersion),NaN!==c&&(b.templateName=configurationToTemplateMapper.lightReportViewer.experience.templateVersion+c.toString())):a.hasOwnProperty("page")&&(b.templateName=configurationToTemplateMapper[a.atom].experience[a.page],b.iconName=configurationToTemplateMapper[a.atom].icon[a.page]):(b.templateName=configurationToTemplateMapper[a.atom].experience,b.iconName=configurationToTemplateMapper[a.atom].icon),b},getAllTemplates=function(){var a,b,c,d;return void 0!==window.sarineViewerTemplates?(d="",a="",b="",c=[],$.each(configuration.experiences,function(e,f){var g;g=getTemplateMapperByConfigName(f),g.templateName&&g.iconName&&(sarineViewerTemplates[g.templateName]&&(d+=sarineViewerTemplates[g.templateName],$.each(g.infos,function(a,d){sarineViewerTemplates[d]&&(c[d]||(b+=sarineViewerTemplates[d],c[d]=!0))})),sarineViewerTemplates[g.iconName]&&(a+=sarineViewerTemplates[g.iconName]))}),{templates:d,icons:a,infoPopups:b}):null},loadTemplate=function(a){var b,c,d;return b=$.Deferred(),c=[],d=[],$("<div>").load(template+window.cacheVersion,function(e){return function(e,f,g){if($(a).prepend($(e).filter(function(e,f){return"SCRIPT"===f.tagName?(f.src?(c.push($.Deferred()),f.src=f.src.replace(getPath(location.origin+location.pathname),getPath(template)),f.src.indexOf("app.bundle.min.js")!==-1&&location.hash.indexOf("debug")!==-1&&(f.src=f.src.replace("app.bundle.min.js","app.bundle.js")),$.ajaxSetup({cache:!0}),$.getScript(f.src,function(){if(c.pop(),0===c.length)return $(a).append(d),bindElementToSelector(a).then(function(){return b.resolve()})})):d.push(f),$(f).remove(),!1):("LINK"===f.tagName&&f.href&&(f.href=f.href.replace(getPath(location.origin+location.pathname),getPath(template))),templateContainers&&"object"==typeof f&&$.each(templateContainers,function(a,b){var c,d;if(c=getTemplateLists(),d=$(f).find(b.value),1===d.length&&c[b.key])return d.append(c[b.key])}),!0)})),0===c.length)return bindElementToSelector(a).then(b.resolve)}}(this)),b.then(function(){return $(document).trigger("loadTemplate")})},existInConfig=function(a){return"undefined"!=typeof configuration.experiences&&configuration.experiences.filter(function(b){return b.atom===a}).length>0},addViewer=function(type,toElement){var callbackPic,data,defer,path,s,src,url;if(defer=$.Deferred(),data=void 0,callbackPic=void 0,$.ajaxSetup({async:!1}),"undefined"==typeof configuration.experiences||existInConfig(type))return void 0===jsonsAllObj?($.getJSON(jsonsAll+window.cacheVersion,function(a){return function(a){return jsonsAllObj=a,data=a[toElement.data("version")||"v1"][type]}}(this)),$.ajaxSetup({async:!0})):data=jsonsAllObj[toElement.data("version")||"v1"][type],callbackPic=data.callbackPic||jsons.replace("{version}",toElement.data("version")||"v1")+"no_stone.png",null===stoneViews.viewers[type]&&(src=callbackPic.split("/"),path=src.pop(),stoneViews.viewers[type]=src.join("/")+"/",data.instance="SarineImage",data.name="sarine.viewer.image",data.args={imagesArr:[path]}),url=logicRoot.replace("{version}",toElement.data("version")||"v1")+data.name+(1===location.hash.indexOf("debug")?".bundle.js":".bundle.min.js")+window.cacheVersion,s=$("<script>",{type:"text/javascript"}).appendTo("body").end()[0],s.onload=function(){var inst;return inst=eval(data.instance),viewers.push(new inst($.extend({src:stoneViews.viewers[type],element:toElement,callbackPic:callbackPic,stoneProperties:stoneViews.stoneProperties,baseUrl:stoneViews.viewersBaseUrl},data.args))),defer.resolve()},s.src=url,defer},ViewerManger.prototype.getViewers=function(){return viewers},ViewerManger.prototype.sortByOrder=function(a){var b;return b=[],a.forEach(function(a){var c;return c=a.element.data("order"),void 0===b[c]&&(b[c]=[]),b[c].push(a)}),b.filter(function(a){return a})},ViewerManger.prototype.init_list=function(a,b,c){var d,e,f,g,h,i,j;j=this,h=a,i=b,c=c||$.Deferred(),e=a.shift(),d=[];for(g in e)f=e[g].id+"_"+e[g].element.data("type"),$(document).trigger(i+"_start",[{Id:f}]),d.push(e[g][i]().then(function(a){return function(){return $(document).trigger(i+"_end",[{Id:a}])}}(f)));return $.when.apply($,d).then(function(){return 0===h.length?($(document).trigger("all_"+i+"_ended"),c.resolve()):j.init_list(h,i,c)}),c},ViewerManger.prototype.first_init=function(){var a;return a=$.Deferred(),this.init_list(this.sortByOrder(viewers),"first_init").then(a.resolve),a},ViewerManger.prototype.full_init=function(){var a;return a=$.Deferred(),this.init_list(this.sortByOrder(viewers),"full_init").then(a.resolve),a},ViewerManger.prototype.stop=function(){return viewers.forEach(function(a){return a.stop()})},ViewerManger.prototype.play=function(){return viewers.forEach(function(a){return a.play(!0)})},ViewerManger}(),this.ViewerManger=ViewerManger}).call(this);
//# sourceMappingURL=sarine.viewer.manager.min.js.map