(function(){var ViewerManger;ViewerManger=function(){function ViewerManger(a){fromTag=a.fromTag,toTag=a.toTag,stoneViews=a.stoneViews,template=a.template,jsons=a.jsons,logicRoot=a.logicRoot,logicPath=a.logicPath,viewers=[],this.bind=a.template?loadTemplate:bindElementToSelector}var addViewer,bindElementToSelector,fromTag,getPath,jsons,loadTemplate,logicPath,logicRoot,stoneViews,template,toTag,viewers;return viewers=[],stoneViews=void 0,fromTag=void 0,toTag=void 0,stoneViews=void 0,template=void 0,jsons=void 0,logicRoot=void 0,logicPath=void 0,ViewerManger.prototype.bind=Error,getPath=function(a){var b;return b=a.split("/"),b.pop(),b.join("/")},bindElementToSelector=function(a){var b;return b=$.Deferred(),$(a).find(fromTag).each(function(){return function(a,c){var d,e;return d=$("<"+toTag+">"),e=$(c).attr("viewer"),d.data("type",e),d.addClass("viewer "+e),d.attr("id","viewr_"+a),$(c).replaceWith(d),addViewer(e,d),b.resolve()}}(this)),b},loadTemplate=function(a){var b,c;return b=$.Deferred(),c=[],$("<div>").load(template,function(d){return $(a).prepend($(d).each(function(){return function(d,e){return"SCRIPT"===e.tagName&&e.src&&(c.push($.Deferred()),e.src=e.src.replace(getPath(location.origin+location.pathname),getPath(template)),$.getScript(e.src,function(){return c.pop(),0===c.length?bindElementToSelector(a).then(function(){return b.resolve()}):void 0}),$(e).remove()),"LINK"===e.tagName&&e.href?e.href=e.href.replace(getPath(location.origin+location.pathname),getPath(template)):void 0}}(this))),0===c.length?bindElementToSelector(a).then(b.resolve):void 0}),b.then(function(){return $(document).trigger("loadTemplate")})},addViewer=function(type,toElement){var data,inst;return data=void 0,$.ajaxSetup({async:!1}),$.getJSON(jsons+type+".json",function(){return function(a){return data=a}}(this)),$.getScript(logicRoot+logicPath.replace(/\{name\}/g,data.name)),$.ajaxSetup({async:!1}),inst=eval(data.instance),viewers.push(new inst($.extend({src:stoneViews[type],element:toElement},data.args))),!0},ViewerManger.prototype.getViewers=function(){return viewers},ViewerManger.prototype.first_init=function(){var a;return a=$.Deferred(),viewers.forEach(function(a){return a.first_init()}),$.when(viewers.map(function(a){return a.first_init_defer})).done(a.resolve),a},ViewerManger.prototype.full_init=function(){var a;return a=$.Deferred(),viewers.forEach(function(a){return a.full_init()}),$.when.apply($,viewers.map(function(a){return a.full_init_defer})).done(a.resolve),a},ViewerManger.prototype.stop=function(){return viewers.forEach(function(a){return a.stop()})},ViewerManger.prototype.play=function(){return viewers.forEach(function(a){return a.play(!0)})},ViewerManger}(),this.ViewerManger=ViewerManger}).call(this);