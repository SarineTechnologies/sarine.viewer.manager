/*! sarine.viewer.manager - v0.0.3 -  Tuesday, February 10th, 2015, 1:56:45 PM */
(function(){var ViewerManger;ViewerManger=function(){function ViewerManger(a){fromTag=a.fromTag,toTag=a.toTag,stoneViews=a.stoneViews,template=a.template,jsons=a.jsons,logicRoot=a.logicRoot,logicRoot=stoneViews.viewersBaseUrl+"{version}/js/",jsons=stoneViews.viewersBaseUrl+"{version}/jsons/",viewers=[],this.bind=a.template?loadTemplate:bindElementToSelector}var addViewer,bindElementToSelector,fromTag,getPath,jsons,loadTemplate,logicPath,logicRoot,stoneViews,template,toTag,viewers;return viewers=[],stoneViews=void 0,fromTag=void 0,toTag=void 0,stoneViews=void 0,template=void 0,jsons=void 0,logicRoot=void 0,logicPath=void 0,ViewerManger.prototype.bind=Error,getPath=function(a){var b;return b=a.split("/"),b.pop(),b.join("/")},bindElementToSelector=function(a){var b,c;return c=$.Deferred(),b=[],$(a).find(fromTag).each(function(){return function(a,c){var d,e;return d=$("<"+toTag+">"),e=$(c).attr("viewer"),d.data("type",e),d.data("version",$(c).attr("version")),d.addClass("viewer "+e),d.attr("id","viewr_"+a),$(c).replaceWith(d),b.push(addViewer(e,d))}}(this)),$.when.apply($,b).then(function(){return c.resolve()}),c},loadTemplate=function(a){var b,c;return b=$.Deferred(),c=[],$("<div>").load(template,function(d){return $(a).prepend($(d).each(function(){return function(d,e){return"SCRIPT"===e.tagName&&e.src&&(c.push($.Deferred()),e.src=e.src.replace(getPath(location.origin+location.pathname),getPath(template)),$.getScript(e.src,function(){return c.pop(),0===c.length?bindElementToSelector(a).then(function(){return b.resolve()}):void 0}),$(e).remove()),"LINK"===e.tagName&&e.href?e.href=e.href.replace(getPath(location.origin+location.pathname),getPath(template)):void 0}}(this))),0===c.length?bindElementToSelector(a).then(b.resolve):void 0}),b.then(function(){return $(document).trigger("loadTemplate")})},addViewer=function(type,toElement){var data,defer;return defer=$.Deferred(),data=void 0,$.ajaxSetup({async:!1}),$.getJSON(jsons.replace("{version}",toElement.data("version")||"v1")+type+".json",function(){return function(a){return data=a}}(this)),$.ajaxSetup({async:!0}),$.getScript(logicRoot.replace("{version}",toElement.data("version")||"v1")+data.name+(1===location.hash.indexOf("debug")?".bundle.js":".bundle.min.js"),function(){var inst;return inst=eval(data.instance),viewers.push(new inst($.extend({src:stoneViews.viewers[type],element:toElement},data.args))),defer.resolve()}),defer},ViewerManger.prototype.getViewers=function(){return viewers},ViewerManger.prototype.first_init=function(){var a;return a=$.Deferred(),viewers.forEach(function(a){return a.first_init()}),$.when(viewers.map(function(a){return a.first_init_defer})).done(a.resolve),a},ViewerManger.prototype.full_init=function(){var a;return a=$.Deferred(),viewers.forEach(function(a){return a.full_init()}),$.when.apply($,viewers.map(function(a){return a.full_init_defer})).done(a.resolve),a},ViewerManger.prototype.stop=function(){return viewers.forEach(function(a){return a.stop()})},ViewerManger.prototype.play=function(){return viewers.forEach(function(a){return a.play(!0)})},ViewerManger}(),this.ViewerManger=ViewerManger}).call(this);